# Copyright Broadcom, Inc. All Rights Reserved.
# SPDX-License-Identifier: APACHE-2.0

command:
  check-app-version:
    exec: sed -nE "s/.wp_version\s*=\s*'([0-9\.]+)';/\1/p" /opt/bitmoa/wordpress/wp-includes/version.php | sed -E 's/^[0-9]+\.[0-9]+$/&.0/'
    exit-status: 0
    stdout:
      - "{{ .Env.APP_VERSION }}"
  # WP-CLI points to correct binaries and config file
  check-wp-cli-conf:
    exec: wp --info
    exit-status: 0
    stdout:
      - "/opt/bitmoa/php/bin/php"
      - "/opt/bitmoa/mysql/bin/mariadb"
      - "/opt/bitmoa/wp-cli/conf/wp-cli.yml"
  check-enabled-modules:
    exec: php -m
    exit-status: 0
    stdout:
    {{ range $module := .Vars.phpmodules }}
      - "{{ $module }}"
    {{ end }}
file:
  # HTTP vhost should have been properly rendered
  /opt/bitmoa/nginx/conf/server_blocks/wordpress-server-block.conf:
    exists: true
    filetype: file
    contents:
      - /root\s+/opt/bitmoa/wordpress/
      - "rewrite ^/bitmoa/wordpress(/.*) $1 last;"
  # HTTPs vhost should have been properly rendered
  /opt/bitmoa/nginx/conf/server_blocks/wordpress-https-server-block.conf:
    exists: true
    filetype: file
    contents:
      - /listen \d+ ssl/
      - /root\s+/opt/bitmoa/wordpress/
      - "rewrite ^/bitmoa/wordpress(/.*) $1 last;"
  # WP-CLI should point to wordpress' installation path
  /opt/bitmoa/wp-cli/conf/wp-cli.yml:
    exists: true
    filetype: file
    contents:
      - /path.*/opt/bitmoa/wordpress/
group:
  daemon:
    exists: true
user:
  daemon:
    exists: true
